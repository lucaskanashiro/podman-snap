#!/usr/bin/env bash

set -Eeuo pipefail

export LD_LIBRARY_PATH="${SNAP}/lib/:${SNAP}/lib/x86_64-linux-gnu/:${SNAP}/usr/lib/:${SNAP}/usr/lib/x86_64-linux-gnu/:${SNAP}/usr/local/lib/"

workaround_apparmor_profile_reload() {
        local aa_profile_reloaded="$SNAP_COMMON/profile_reloaded"
        # https://github.com/docker/docker-snap/issues/4
        if [ ! -f "$aa_profile_reloaded" ]; then
                local aa_count
                if aa_count="$(grep -c 'docker-default (enforce)' /sys/kernel/security/apparmor/profiles)" && [ -n "$aa_count" ] && [ "$aa_count" -ge 1 ]; then
                        export AA_RELOAD=1
                        touch "$aa_profile_reloaded"
                fi
        fi
}

workaround_apparmor_profile_reload

${SNAP}/bin/podman-orig "$@"
